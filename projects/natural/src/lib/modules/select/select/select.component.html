<!-- Autocomplete menu -->
<mat-autocomplete
    #ac="matAutocomplete"
    (optionSelected)="propagateValue($event.option.value)"
    [displayWith]="getDisplayFn()"
    panelWidth="auto !important"
>
    <mat-option *ngFor="let item of items | async" [value]="item">
        <ng-template
            [ngTemplateOutletContext]="{item: item}"
            [ngTemplateOutlet]="itemTemplate ? itemTemplate : defaultACItem"
        ></ng-template>
    </mat-option>
    <div *ngIf="moreNbItems > 0" class="mat-caption" i18n style="padding: 5px 10px"
        >{{ moreNbItems }} élément(s) supplémentaire(s)</div
    >
</mat-autocomplete>

<ng-template #defaultACItem let-item="item">
    <span>{{ getDisplayFn()(item) }}</span>
</ng-template>

<!-- Input for autocomplete -->
<mat-form-field>
    <mat-label>{{ placeholder }}</mat-label>

    <input
        (blur)="onBlur()"
        (change)="onInternalFormChange()"
        (click)="autoTrigger.openPanel()"
        (focus)="startSearch()"
        (keydown.esc)="reset()"
        (keydown.enter)="onKeyEnter()"
        [formControl]="internalCtrl"
        [matAutocomplete]="ac"
        aria-label="Recherche et sélection"
        i18n-aria-label
        matInput
        [errorStateMatcher]="matcher"
    />

    <!-- Meta data -->
    <mat-icon *ngIf="!loading && showIcon" [naturalIcon]="icon" matIconPrefix></mat-icon>

    <div class="loading-wrapper" matIconPrefix *ngIf="loading">
        <mat-progress-spinner [diameter]="21" [strokeWidth]="5" mode="indeterminate"></mat-progress-spinner>
    </div>

    <!-- Clear button -->
    <div class="suffix-buttons" matIconSuffix>
        <button
            *ngIf="internalCtrl.pristine && internalCtrl.value && internalCtrl.enabled && !clearLabel"
            (click)="clear()"
            mat-icon-button
            i18n-matTooltip
            matTooltip="Désélectionner"
        >
            <mat-icon naturalIcon="close"></mat-icon>
        </button>
        <button
            *ngIf="internalCtrl.dirty && internalCtrl.enabled && optionRequired"
            (click)="reset()"
            mat-icon-button
            i18n-matTooltip
            matTooltip="Annuler la recherche"
        >
            <mat-icon naturalIcon="undo"></mat-icon>
        </button>
        <button
            *ngIf="internalCtrl.pristine && internalCtrl.value && navigateTo"
            [routerLink]="navigateTo"
            (click)="$event.stopPropagation()"
            mat-icon-button
            i18n-matTooltip
            matTooltip="Naviguer vers"
        >
            <mat-icon naturalIcon="open_in_browser"></mat-icon>
        </button>
    </div>

    <mat-error *ngIf="hasRequiredError()" i18n>Ce champ est requis</mat-error>
</mat-form-field>

<!-- Additional (un)select/(un)link buttons for more visual cohesion with natural-relations --><!-- [clearLabel] and/or [selectLabel] has to be given as attribute input -->
<div *ngIf="showClearButton()" class="external-buttons">
    <button (click)="clear()" *ngIf="showClearButton()" color="warn" mat-button>{{ clearLabel }}</button>
</div>
