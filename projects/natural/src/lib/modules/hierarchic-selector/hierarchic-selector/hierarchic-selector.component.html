<ng-template #displayTemplate let-node>
    <div class="nat-horizontal nat-gap-5">
        @if (node.config.icon) {
            <mat-icon [naturalIcon]="node.config.icon" />
        }
        <span>{{ getDisplayFn(node.config)(node.model) }}</span>
    </div>
</ng-template>

<div [style.margin-bottom.px]="20">
    <natural-search [facets]="searchFacets()" [selections]="searchSelections()" (selectionChange)="search($event)" />
</div>

@if (allowSelectAll() && multiple()) {
    <div
        class="select-all"
        [matTooltip]="hierarchicSelectorService.isTooBig() ? 'Trop de résultats, veuillez affiner la recherche' : null"
    >
        <a i18n mat-button [disabled]="hierarchicSelectorService.isTooBig()" (click)="selectAll()">Tout sélectionner</a>
    </div>
}

<div class="body">
    @if (loading) {
        <mat-progress-spinner mode="indeterminate" style="margin: 10px" [diameter]="36" />
    }

    <mat-tree #tree [dataSource]="dataSource" [childrenAccessor]="childrenAccessor">
        <mat-nested-tree-node
            *matTreeNodeDef="let node"
            matTreeNodePadding
            [ngClass]="{leaf: !node.isExpandable}"
            (expandedChange)="$event ? loadChildren(node) : null"
        >
            <div class="wrapper nat-horizontal nat-align" [class.unexpandable]="!node.isExpandable">
                @if (node.isExpandable) {
                    <button mat-icon-button matTreeNodeToggle [attr.aria-label]="`toggle ${node.model.name}`">
                        @if (node.isLoading) {
                            <mat-progress-spinner mode="indeterminate" [diameter]="24" [strokeWidth]="5" />
                        } @else {
                            <mat-icon [naturalIcon]="tree.isExpanded(node) ? 'expand_more' : 'chevron_right'" />
                        }
                    </button>
                }

                @if (multiple()) {
                    <mat-checkbox
                        class="selection"
                        [checked]="selection.isSelected(node)"
                        [disabled]="!node.isSelectable"
                        (change)="toggleSelection(node)"
                    >
                        <ng-template *ngTemplateOutlet="displayTemplate; context: {$implicit: node}" />
                    </mat-checkbox>
                } @else {
                    <mat-radio-button
                        class="selection"
                        [checked]="selection.isSelected(node)"
                        [disabled]="!node.isSelectable"
                        (change)="toggleSelection(node)"
                    >
                        <ng-template *ngTemplateOutlet="displayTemplate; context: {$implicit: node}" />
                    </mat-radio-button>
                }
            </div>
            <div class="children" [class.invisible]="!tree.isExpanded(node)">
                <ng-container matTreeNodeOutlet />
            </div>
        </mat-nested-tree-node>
    </mat-tree>

    <mat-chip-listbox aria-orientation="vertical" class="mat-mdc-chip-set-stacked">
        @for (node of selection.selected; track node.model.id) {
            <mat-chip-option [removable]="true" [selectable]="false" (removed)="unselect(node)">
                @if (node.config.icon) {
                    <mat-icon matChipAvatar [naturalIcon]="node.config.icon" />
                }
                {{ node.model.name || node.model.fullName }}
                <button matChipRemove>
                    <mat-icon naturalIcon="cancel" />
                </button>
            </mat-chip-option>
        } @empty {
            <p class="mat-body nat-padding-horizontal" i18n>Aucune sélection</p>
        }
    </mat-chip-listbox>
</div>

@if (!loading && !dataSource.data.length) {
    <div i18n>Aucun résultat</div>
}
